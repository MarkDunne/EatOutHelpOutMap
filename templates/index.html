<!DOCTYPE html>
<html>
<head>
    <title>Eat out to help out map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>

    <style>
        #postcode-form {
            margin-bottom: 20px;
        }

        #map {
            height: 800px;
        }
    </style>

</head>
<body>

<div id="container">
    <div id="postcode-form">
        <label>
            Postcode: <input type="text" id="postcode-input">
        </label>
        <button id="submit-postcode">Search</button>
    </div>
    <div id='map'></div>
</div>


<script>
    let restaurant_set = new Set()
    let lat = 51.5080, lon = -0.1281

    let map = L.map('map', {
        minZoom: 12,
        maxZoom: 19
    }).setView([lat, lon], 16);
    var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    map.on('moveend', evt => {
        console.log('Loading new restaurants')
        let center = map.getCenter();

        fetch(`/restaurants?longitude=${center.lng}&latitude=${center.lat}`).then(response => response.json()).then(data => {
            for (let restaurant of data) {
                if ('lng' in restaurant && 'lat' in restaurant) {
                    let restaurant_key = JSON.stringify(restaurant)
                    if (!restaurant_set.has(restaurant_key)) {
                        restaurant_set.add(restaurant_key)
                        let marker = L.marker([restaurant.lat, restaurant.lng]).addTo(map);
                        marker.bindPopup(restaurant.Name)
                    }
                }
            }
        })
    })

    document.getElementById('submit-postcode').addEventListener('click', event => {
        let postcode = document.getElementById('postcode-input').value
        fetch(`https://api.postcodes.io/postcodes/${postcode}`).then(response => response.json()).then(data => {
            map.panTo(new L.LatLng(data.result.latitude, data.result.longitude));
        })
    })

    map.fire('moveend')

</script>
</body>
</html>